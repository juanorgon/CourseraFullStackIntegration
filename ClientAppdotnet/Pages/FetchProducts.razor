@page "/fetchproducts"
@inject HttpClient Http


<h3 class="mt-4">Agregar nuevo producto</h3>
<EditForm Model="newProduct" OnValidSubmit="CreateProduct">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div class="mb-2">
        <label>Nombre</label>
        <InputText class="form-control" @bind-Value="newProduct.Name" />
        <ValidationMessage For="@(() => newProduct.Name)" />
    </div>
    <div class="mb-2">
        <label>Precio</label>
        <InputNumber class="form-control" @bind-Value="newProduct.Price" />
        <ValidationMessage For="@(() => newProduct.Price)" />
    </div>
    <div class="mb-2">
        <label>Stock</label>
        <InputNumber class="form-control" @bind-Value="newProduct.Stock" />
        <ValidationMessage For="@(() => newProduct.Stock)" />
    </div>
    <div class="mb-2">
        <label>Categoría</label>
        <InputText class="form-control" @bind-Value="newProduct.Category.Name" />
        <ValidationMessage For="@(() => newProduct.Category.Name)" />
    </div>
    <button class="btn btn-primary" type="submit">Crear</button>
</EditForm>

<h3 class="mt-4">Lista de productos</h3>
<div class="table-responsive">
    <table class="table table-striped table-bordered align-middle">
        <thead class="table-light">
            <tr>
                <th>Nombre</th>
                <th>Precio</th>
                <th>Stock</th>
                <th>Categoría</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
        @if (products != null)
        {
            foreach (var product in products)
            {
                <tr>
                    @if (editProduct != null && editProduct.Id == product.Id)
                    {
                        <td colspan="5">
                            <EditForm Model="editProduct" OnValidSubmit="() => UpdateProduct(product.Id)">
                                <div class="row g-2">
                                    <div class="col-md-3">
                                        <InputText class="form-control" @bind-Value="editProduct.Name" />
                                        <ValidationMessage For="@(() => editProduct.Name)" />
                                    </div>
                                    <div class="col-md-2">
                                        <InputNumber class="form-control" @bind-Value="editProduct.Price" />
                                        <ValidationMessage For="@(() => editProduct.Price)" />
                                    </div>
                                    <div class="col-md-2">
                                        <InputNumber class="form-control" @bind-Value="editProduct.Stock" />
                                        <ValidationMessage For="@(() => editProduct.Stock)" />
                                    </div>
                                    <div class="col-md-3">
                                        <InputText class="form-control" @bind-Value="editProduct.Category.Name" />
                                        <ValidationMessage For="@(() => editProduct.Category.Name)" />
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-success me-2" type="submit">Guardar</button>
                                        <button class="btn btn-secondary" type="button" @onclick="CancelEdit">Cancelar</button>
                                    </div>
                                </div>
                            </EditForm>
                        </td>
                    }
                    else
                    {
                        <td>@product.Name</td>
                        <td>$@product.Price</td>
                        <td>@product.Stock</td>
                        <td>@product.Category?.Name</td>
                        <td>
                            <button class="btn btn-warning btn-sm me-2" @onclick="() => StartEdit(product)">Editar</button>
                            <button class="btn btn-danger btn-sm" @onclick="() => DeleteProduct(product.Id)">Borrar</button>
                        </td>
                    }
                </tr>
            }
        }
        else
        {
            <tr><td colspan="5">Loading...</td></tr>
        }
        </tbody>
    </table>
</div>

@using System.ComponentModel.DataAnnotations
@code {
    private Product[]? products;
    private Product newProduct = new Product { Category = new Category() };
    private Product? editProduct;

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        try
        {
            products = await Http.GetFromJsonAsync<Product[]>("http://localhost:5164/api/products");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching products: {ex.Message}");
        }
    }

    private async Task CreateProduct()
    {
        var response = await Http.PostAsJsonAsync("http://localhost:5164/api/products", newProduct);
        if (response.IsSuccessStatusCode)
        {
            newProduct = new Product { Category = new Category() };
            await LoadProducts();
        }
    }

    private void StartEdit(Product product)
    {
        // Deep copy para evitar modificar el listado hasta guardar
        editProduct = new Product
        {
            Id = product.Id,
            Name = product.Name,
            Price = product.Price,
            Stock = product.Stock,
            Category = new Category { Id = product.Category?.Id ?? 0, Name = product.Category?.Name ?? string.Empty }
        };
    }

    private void CancelEdit()
    {
        editProduct = null;
    }

    private async Task UpdateProduct(int id)
    {
        if (editProduct == null) return;
        var response = await Http.PutAsJsonAsync($"http://localhost:5164/api/products/{id}", editProduct);
        if (response.IsSuccessStatusCode)
        {
            editProduct = null;
            await LoadProducts();
        }
    }

    private async Task DeleteProduct(int id)
    {
        var response = await Http.DeleteAsync($"http://localhost:5164/api/products/{id}");
        if (response.IsSuccessStatusCode)
        {
            await LoadProducts();
        }
    }

    public class Product
    {
        public int Id { get; set; }

        [Required(ErrorMessage = "El nombre es obligatorio")]
        [StringLength(100, ErrorMessage = "Máximo 100 caracteres")]
        public string Name { get; set; } = string.Empty;

        [Range(0.01, 100000, ErrorMessage = "Precio debe ser mayor a 0")]
        public double Price { get; set; }

        [Range(0, 100000, ErrorMessage = "Stock no puede ser negativo")]
        public int Stock { get; set; }

        [Required]
        public Category Category { get; set; } = new Category();
    }

    public class Category
    {
        public int Id { get; set; }

        [Required(ErrorMessage = "La categoría es obligatoria")]
        [StringLength(50, ErrorMessage = "Máximo 50 caracteres")]
        public string Name { get; set; } = string.Empty;
    }
}